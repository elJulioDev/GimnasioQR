{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Moderador - ClubHouse Digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/indexModerador.css' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'img/icono.svg' %}">
    <style>
        .table-container { width: 100%; overflow-x: auto; margin-bottom: 1rem; }
        .truncate-text { max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .wrap-text { white-space: normal; word-wrap: break-word; max-width: 150px; }

        /* Modal Styles */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); z-index: 9999; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .modal-overlay.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: #1e1e2f; border: 1px solid #ff4757; border-radius: 16px; padding: 2rem; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-icon { font-size: 4rem; color: #ff4757; margin-bottom: 1rem; }
        .modal-title { font-size: 1.5rem; color: #fff; margin-bottom: 0.5rem; font-weight: 700; }
        .modal-message { color: #a0a0a0; margin-bottom: 1.5rem; font-size: 0.95rem; }
        .modal-user-info { background: rgba(255, 71, 87, 0.1); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
        .modal-user-name { color: #fff; font-weight: 600; font-size: 1.1rem; }
        .modal-user-rut { color: #ff4757; font-size: 0.9rem; margin-top: 4px; }
        .modal-actions { display: flex; gap: 1rem; justify-content: center; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-cancel { background: transparent; border: 1px solid #444; color: #fff; }
        .btn-cancel:hover { background: #333; }
        .btn-delete { background: #ff4757; color: #fff; }
        .btn-delete:hover { background: #ff2f47; }
        
        /* Action Buttons */
        .action-buttons { display: flex; gap: 8px; }
        .btn-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: 0.2s; text-decoration: none; }
        .btn-icon.view { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-icon.view:hover { background: rgba(255,255,255,0.2); }
        .btn-icon.edit { background: rgba(60, 64, 198, 0.2); color: #575fcf; }
        .btn-icon.edit:hover { background: rgba(60, 64, 198, 0.4); }
        .btn-icon.delete { background: rgba(255, 71, 87, 0.2); color: #ff4757; }
        .btn-icon.delete:hover { background: rgba(255, 71, 87, 0.4); }

        /* ==================== STATS GRID COMPACTO ==================== */
        .stats-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card-compact {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.3s ease;
        }

        .stat-card-compact:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .stat-compact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .stat-compact-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-compact-header i {
            font-size: 1.5rem;
        }

        .stat-compact-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .stat-trend-indicator {
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ==================== MANAGEMENT SECTION ==================== */
        .management-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .chart-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .chart-header h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ==================== MODERN TABLE ==================== */
        .modern-table {
            width: 100%;
            border-collapse: collapse;
            background: transparent;
        }

        .modern-table thead {
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 2px solid var(--border-color);
        }

        .modern-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modern-table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s ease;
        }

        .modern-table tbody tr:hover {
            background: rgba(0, 255, 157, 0.03);
        }

        .modern-table td {
            padding: 1rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        /* ==================== STATUS BADGES ==================== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.active {
            background: rgba(46, 213, 115, 0.15);
            color: #2ed573;
        }

        .status-badge.expired {
            background: rgba(255, 71, 87, 0.15);
            color: #ff4757;
        }

        /* ==================== VARIABLES CSS ==================== */
        :root {
            --primary-color: #00ff9d;
            --success-color: #2ed573;
            --danger-color: #ff4757;
            --warning-color: #ffa502;
            --info-color: #3742fa;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --bg-primary: #0a0a0a;
            --bg-card: rgba(255, 255, 255, 0.02);
            --border-color: rgba(255, 255, 255, 0.1);
        }

        /* ==================== HEADER STYLES ==================== */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-qr {
            background: var(--primary-color);
            color: #000;
        }

        .btn-qr:hover {
            background: #00d47f;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 255, 157, 0.3);
        }


    </style>
</head>
<body>

    <div class="dashboard-wrapper">
        <nav class="sidebar">
            <div class="sidebar-logo">
                <i class="fas fa-dumbbell"></i>
                <div>
                    <h1>ClubHouse</h1>
                    <span class="role-badge">Moderador</span>
                </div>
            </div>
            
            <ul class="sidebar-nav">
                <li class="nav-section-title">Principal</li>
                <li><a href="#" class="nav-link active" data-target="dashboard"><i class="fas fa-chart-line"></i><span>Dashboard</span></a></li>
                <li class="nav-section-title">Gestión</li>
                <li><a href="#" class="nav-link" data-target="usuarios"><i class="fas fa-users"></i><span>Usuarios</span></a></li>
                <li><a href="#" class="nav-link" data-target="pagos"><i class="fas fa-credit-card"></i><span>Pagos / Renovación</span></a></li>
                <li class="nav-section-title">Control de Acceso</li>
                <li><a href="#" class="nav-link" data-target="qr-scanner"><i class="fas fa-qrcode"></i><span>Escáner QR</span></a></li>
            </ul>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">MO</div>
                    <div class="user-info">
                        <h4 id="userName">Moderador</h4>
                        <p id="userRole">Staff</p>
                    </div>
                </div>
                <a href="{% url 'cerrar_sesion' %}" class="logout-button"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span></a>
                <div class="copyright">© 2025 ClubHouse Digital</div>
            </div>
        </nav>

        <main class="main-content">
            <section id="dashboard" class="content-section active">
                <div class="content-header" style="margin-bottom: 1.5rem;">
                    <div>
                        <h2 class="page-title" style="font-size: 1.5rem;">
                            <i class="fas fa-chart-line"></i> Dashboard
                        </h2>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">Vista general del rendimiento del negocio</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-qr" onclick="openQRWindow()">
                            <i class="fas fa-qrcode"></i> Abrir Escáner QR (2° Monitor)
                        </button>
                    </div>
                </div>
                
                <!-- Stats Grid Compacto -->
                <div class="stats-grid-compact">
                    <!-- Card 1: Accesos Hoy -->
                    <div class="stat-card-compact" style="border-left: 3px solid var(--primary-color);">
                        <div class="stat-compact-header">
                            <span class="stat-compact-label">Accesos Hoy</span>
                            <i class="fas fa-qrcode" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="stat-compact-value">{{ accesos_hoy }}</div>
                        <div class="stat-trend-indicator" style="color: {% if cambio_accesos.es_positivo %}var(--success-color){% else %}var(--danger-color){% endif %};">
                            <i class="fas {% if cambio_accesos.es_positivo %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                            {{ cambio_accesos.porcentaje }}% vs ayer
                        </div>
                    </div>

                    <!-- Card 2: Usuarios Activos -->
                    <div class="stat-card-compact">
                        <div class="stat-compact-header">
                            <span class="stat-compact-label">Usuarios Activos</span>
                            <i class="fas fa-user-check" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="stat-compact-value">{{ usuarios_activos }}</div>
                        <div class="stat-trend-indicator" style="color: {% if cambio_usuarios.es_positivo %}var(--success-color){% else %}var(--danger-color){% endif %};">
                            <i class="fas {% if cambio_usuarios.es_positivo %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                            {{ cambio_usuarios.porcentaje }}% vs mes anterior
                        </div>
                    </div>
                    
                    <!-- Card 3: Planes por Vencer -->
                    <div class="stat-card-compact" style="border-left: 3px solid var(--warning-color);">
                        <div class="stat-compact-header">
                            <span class="stat-compact-label">Planes por Vencer</span>
                            <i class="fas fa-user-clock" style="color: var(--warning-color);"></i>
                        </div>
                        <div class="stat-compact-value">{{ planes_vencer }}</div>
                        <div class="stat-trend-indicator" style="color: {% if cambio_planes.es_positivo %}var(--success-color){% else %}var(--danger-color){% endif %};">
                            <i class="fas {% if cambio_planes.es_positivo %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                            {{ cambio_planes.porcentaje }}% próximos 7 días
                        </div>
                    </div>
                </div>

                <!-- Últimos Accesos con estilo de bitácora admin -->
                <div class="management-section">
                    <div class="chart-header">
                        <h3><i class="fas fa-history"></i> Bitácora de Accesos (Hoy)</h3>
                    </div>
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Usuario</th>
                                <th>Plan</th>
                                <th>Estado</th>
                                <th>Detalle</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in ultimos_accesos %}
                            <tr>
                                <td style="font-weight: 600; color: var(--text-primary);">{{ log.timestamp|date:"H:i:s" }}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        {{ log.user.first_name }} {{ log.user.last_name }}
                                    </div>
                                </td>
                                <td>
                                    {% if log.membership %}
                                        {{ log.membership.plan.name }}
                                    {% else %}
                                        <span style="color: var(--text-secondary);">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if log.status == 'allowed' %}
                                        <span class="status-badge active">
                                            <i class="fas fa-check"></i> Permitido
                                        </span>
                                    {% else %}
                                        <span class="status-badge expired">
                                            <i class="fas fa-times"></i> Denegado
                                        </span>
                                    {% endif %}
                                </td>
                                <td style="font-size: 0.85rem; color: var(--text-secondary);">
                                    {% if log.status == 'denied' %}
                                        {{ log.denial_reason }}
                                    {% else %}
                                        Acceso Correcto
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem;">
                                    No hay registros de acceso hoy.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>


            <section id="usuarios" class="content-section">
                <div class="content-header">
                    <h2 class="page-title"><i class="fas fa-users"></i> Gestión de Usuarios</h2>
                    <a href="{% url 'moderador_nuevo_usuario' %}" class="btn btn-primary" style="text-decoration: none;">
                        <i class="fas fa-plus"></i> Nuevo Usuario
                    </a>
                </div>
                <div class="management-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-usuarios" placeholder="Buscar por RUT, nombre o correo...">
                    </div>
                    
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>NOMBRE</th>
                                <th>PLAN ACTUAL</th>
                                <th>ÚLTIMO ACCESO</th>
                                <th>ESTADO</th>
                                <th>ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="usuarios-tbody">
                            {% for item in lista_usuarios %}
                            <tr class="user-row">
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="user-name" style="font-weight: 600; color: var(--text-primary);">{{ item.user.get_full_name }}</span>
                                    </div>
                                </td>
                                <td>
                                    {% if item.plan_name != 'Sin Plan Activo' %}
                                        <div style="display: flex; flex-direction: column;">
                                            <span style="color: var(--primary-color); font-weight: 500; font-size: 0.9rem;">
                                                <i class="fas fa-crown" style="font-size: 0.7rem;"></i> {{ item.plan_name }}
                                            </span>
                                            <span style="font-size: 0.75rem; color: #888;">Quedan {{ item.dias_restantes }} días</span>
                                        </div>
                                    {% else %}
                                        <span style="color: #666; font-style: italic;">Sin Plan</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.last_access %}
                                        <div style="display: flex; flex-direction: column;">
                                            <span style="color: #fff; font-size: 0.9rem;">{{ item.last_access|date:"d/m/Y" }}</span>
                                            <span style="color: #666; font-size: 0.75rem;">{{ item.last_access|date:"H:i" }} hrs</span>
                                        </div>
                                    {% else %}
                                        <span style="color: #666; font-style: italic; font-size: 0.85rem;">Nunca</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.status_class == 'active' %}
                                        <span style="background: rgba(46, 213, 115, 0.15); color: #2ed573; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">Activo</span>
                                    {% else %}
                                        <span style="background: rgba(255, 71, 87, 0.15); color: #ff4757; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">Inactivo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{% url 'moderador_ver_usuario' item.user.id %}" class="btn-icon view" title="Ver Detalles"><i class="fas fa-eye"></i></a>
                                        <a href="{% url 'moderador_editar_usuario' item.user.id %}" class="btn-icon edit" title="Editar"><i class="fas fa-edit"></i></a>
                                        <button class="btn-icon delete" title="Eliminar" onclick="showDeleteModal('{% url 'moderador_eliminar_usuario' item.user.id %}', '{{ item.user.get_full_name }}', '{{ item.user.rut }}')"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 3rem; color: #666;">
                                    <i class="fas fa-users-slash" style="font-size: 2rem; margin-bottom: 10px; display: block; opacity: 0.5;"></i>
                                    No se encontraron usuarios registrados.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="pagos" class="content-section">
                <div class="content-header">
                    <h2 class="page-title"><i class="fas fa-credit-card"></i> Registrar Pago / Renovación</h2>
                </div>
                <div class="management-section">
                    <h3 class="section-title"><i class="fas fa-search"></i> Buscar Socio</h3>
                    <form id="searchUserForm">
                        <div class="form-group">
                            <label for="search-user">Buscar Socio (por RUT o Nombre)</label>
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="search-user" placeholder="Ej: 11.222.333-4 o María González" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;"><i class="fas fa-search"></i> Buscar Usuario</button>
                    </form>
                </div>
                <div class="management-section" id="payment-details-section" style="display: none; margin-top: 2rem;">
                    <h3 class="section-title"><i class="fas fa-user-circle"></i> Datos del Socio</h3>
                    <div class="user-payment-card">
                        <div class="user-payment-header">
                            <div class="user-payment-avatar" id="payment-avatar"></div>
                            <div class="user-payment-info">
                                <h3 id="payment-name"></h3>
                                <p id="payment-rut"></p>
                                <p id="payment-email"></p>
                            </div>
                            <div class="user-payment-status"><span class="status-badge" id="payment-status-badge"></span></div>
                        </div>
                        <div class="user-payment-plan-info">
                            <div class="plan-info-item"><i class="fas fa-clipboard-list"></i><div><span class="plan-label">Plan Actual</span><span class="plan-value" id="payment-plan"></span></div></div>
                            <div class="plan-info-item"><i class="fas fa-calendar-check"></i><div><span class="plan-label">Fecha de Inicio</span><span class="plan-value" id="payment-start"></span></div></div>
                            <div class="plan-info-item"><i class="fas fa-calendar-times"></i><div><span class="plan-label">Fecha de Vencimiento</span><span class="plan-value" id="payment-expiry"></span></div></div>
                            <div class="plan-info-item"><i class="fas fa-clock"></i><div><span class="plan-label">Días Restantes</span><span class="plan-value" id="payment-days-left"></span></div></div>
                        </div>
                    </div>
                    <form id="renewalForm" style="margin-top: 2rem;">
                        <h3 class="section-title"><i class="fas fa-sync-alt"></i> Renovar Plan</h3>
                        <div class="form-group">
                            <label for="select-plan">Seleccionar Plan</label>
                            <select id="select-plan" required style="width: 100%; padding: 12px; border-radius: 8px; background: #2a2a3c; color: white; border: 1px solid #444;">
                                <option value="">-- Seleccione un plan --</option>
                                {% for plan in planes_renovacion %}
                                    <option value="{{ plan.id }}" data-name="{{ plan.name }}" data-days="{{ plan.duration_days }}" data-price="{{ plan.price }}">{{ plan.name }} - ${{ plan.price }} ({{ plan.duration_days }} días)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="payment-method">Método de Pago</label>
                            <select id="payment-method" required style="width: 100%; padding: 12px; border-radius: 8px; background: #2a2a3c; color: white; border: 1px solid #444;">
                                <option value="">-- Seleccione método --</option>
                                <option value="efectivo">Efectivo</option>
                                <option value="tarjeta">Tarjeta (Transbank)</option>
                                <option value="transferencia">Transferencia Bancaria</option>
                            </select>
                        </div>
                        <input type="hidden" id="payment-amount"> 
                        <div class="form-group">
                            <label for="payment-notes">Notas (Opcional)</label>
                            <textarea id="payment-notes" rows="3" style="width: 100%; padding: 14px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: white; resize: vertical;"></textarea>
                        </div>
                        <div class="payment-summary" id="summary-box" style="display: none; background: rgba(60, 64, 198, 0.1); padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid rgba(60, 64, 198, 0.3);">
                            <h4><i class="fas fa-receipt"></i> Resumen</h4>
                            <div class="summary-item" style="display: flex; justify-content: space-between;"><span>Plan:</span><strong id="sum-plan">-</strong></div>
                            <div class="summary-item" style="display: flex; justify-content: space-between;"><span>Vence:</span><strong id="sum-date" style="color: #2ed573;">-</strong></div>
                            <div class="summary-item total" style="display: flex; justify-content: space-between; font-size: 1.2rem; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;"><span>Total:</span><strong id="sum-total">$0</strong></div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;"><i class="fas fa-check-circle"></i> Confirmar Renovación</button>
                        <button type="button" class="btn btn-secondary" onclick="resetPaymentForm()" style="width: 100%; margin-top: 1rem;"><i class="fas fa-times"></i> Cancelar</button>
                    </form>
                </div>
            </section>

            <section id="qr-scanner" class="content-section">
                <div class="content-header">
                    <h2 class="page-title"><i class="fas fa-qrcode"></i> Control de Acceso QR</h2>
                </div>
                <div class="management-section" style="text-align: center; padding: 4rem 2rem;">
                    <i class="fas fa-desktop" style="font-size: 5rem; color: var(--primary-color); margin-bottom: 2rem; display: block;"></i>
                    <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">Escáner QR en Segundo Monitor</h3>
                    <button class="btn btn-qr" onclick="openQRWindow()" style="font-size: 1.1rem; padding: 16px 32px;"><i class="fas fa-qrcode"></i> Abrir Escáner QR</button>
                </div>
            </section>

        </main>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal-content">
            <i class="fas fa-exclamation-circle modal-icon"></i>
            <h2 class="modal-title">¿Eliminar Usuario?</h2>
            <p class="modal-message">Esta acción es permanente y no se puede deshacer. Se eliminará toda la información asociada al socio.</p>
            <div class="modal-user-info">
                <div class="modal-user-name" id="modalUserName"></div>
                <div class="modal-user-rut" id="modalUserRut"></div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeDeleteModal()"><i class="fas fa-times"></i> Cancelar</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="modal-btn btn-delete"><i class="fas fa-trash-alt"></i> Sí, Eliminar</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- MODAL ---
        function showDeleteModal(deleteUrl, userName, userRut) {
            document.getElementById('modalUserName').textContent = userName;
            document.getElementById('modalUserRut').textContent = 'RUT: ' + userRut;
            document.getElementById('deleteForm').action = deleteUrl;
            document.getElementById('deleteModal').classList.add('active');
        }
        function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('active'); }
        document.getElementById('deleteModal').addEventListener('click', function(e) { if (e.target === this) closeDeleteModal(); });

        // --- NAVEGACION ---
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.content-section');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    sections.forEach(section => section.classList.remove('active'));
                    const targetId = this.getAttribute('data-target');
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) targetSection.classList.add('active');
                });
            });

            // Buscador Tabla Usuarios
            const searchInput = document.getElementById('search-usuarios');
            if(searchInput){
                searchInput.addEventListener('keyup', function() {
                    const term = this.value.toLowerCase();
                    const rows = document.querySelectorAll('#usuarios-tbody .user-row');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(term) ? '' : 'none';
                    });
                });
            }
        });

        function openQRWindow() { 
            // Definimos características que obliguen al navegador a tratarlo como una ventana segura
            // 'location=yes' y 'toolbar=yes' son CLAVES para que el navegador permita pedir permisos de cámara
            const features = 'width=1280,height=720,resizable=yes,scrollbars=yes,status=yes,location=yes,toolbar=yes';
            
            // Abrimos la ventana con un nombre específico 'QRScannerWindow' para no abrir múltiples instancias
            window.open("{% url 'mostrar_Scanner' %}", 'QRScannerWindow', features); 
        }

        // --- PAGOS ---
        document.getElementById('searchUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const query = document.getElementById('search-user').value;
            const btn = this.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
            btn.disabled = true;

            fetch(`/api/buscar-socio/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    if (data.success) { mostrarDatosSocio(data.user); } 
                    else { alert(data.error || "Usuario no encontrado"); ocultarSeccionPagos(); }
                })
                .catch(error => { console.error(error); alert("Error de conexión"); btn.innerHTML = originalText; btn.disabled = false; });
        });

        function mostrarDatosSocio(user) {
            document.getElementById('payment-details-section').style.display = 'block';
            document.getElementById('payment-avatar').textContent = user.initials;
            document.getElementById('payment-name').textContent = user.full_name;
            document.getElementById('payment-rut').textContent = user.rut;
            document.getElementById('payment-rut').dataset.rawRut = user.rut;
            document.getElementById('payment-email').textContent = user.email;
            document.getElementById('payment-plan').textContent = user.plan_actual;
            document.getElementById('payment-start').textContent = user.fecha_inicio || '-';
            document.getElementById('payment-expiry').textContent = user.fecha_vencimiento || '-';
            document.getElementById('payment-days-left').textContent = user.dias_restantes + ' días';
            
            const badge = document.getElementById('payment-status-badge');
            badge.textContent = user.estado;
            if(user.estado === 'Activo') { badge.style.background = 'rgba(46, 213, 115, 0.2)'; badge.style.color = '#2ed573'; } 
            else { badge.style.background = 'rgba(255, 71, 87, 0.2)'; badge.style.color = '#ff4757'; }
        }

        function ocultarSeccionPagos() {
            document.getElementById('payment-details-section').style.display = 'none';
            document.getElementById('renewalForm').reset();
            document.getElementById('summary-box').style.display = 'none';
        }

        document.getElementById('select-plan').addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            if (selected.value) {
                const precio = selected.getAttribute('data-price');
                const nombrePlan = selected.getAttribute('data-name');
                const dias = parseInt(selected.getAttribute('data-days'));
                const hoy = new Date();
                hoy.setDate(hoy.getDate() + dias);
                document.getElementById('summary-box').style.display = 'block';
                document.getElementById('sum-plan').textContent = nombrePlan;
                document.getElementById('sum-total').textContent = '$' + parseInt(precio).toLocaleString('es-CL');
                document.getElementById('sum-date').textContent = hoy.toLocaleDateString('es-CL');
                document.getElementById('payment-amount').value = precio;
            } else { document.getElementById('summary-box').style.display = 'none'; }
        });

        document.getElementById('renewalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const rut = document.getElementById('payment-rut').dataset.rawRut;
            const planId = document.getElementById('select-plan').value;
            const metodoPago = document.getElementById('payment-method').value;
            const notas = document.getElementById('payment-notes').value;
            const btn = this.querySelector('button[type="submit"]');

            if (confirm("¿Confirmar renovación y registrar el pago?")) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                fetch('/api/renovar-plan/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ rut: rut, plan_id: planId, payment_method: metodoPago, notes: notas })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) { alert("¡Pago registrado!"); location.reload(); } 
                    else { alert("Error: " + data.error); btn.disabled = false; btn.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Renovación'; }
                })
                .catch(error => { console.error(error); alert("Error al procesar"); btn.disabled = false; btn.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Renovación'; });
            }
        });
        window.resetPaymentForm = ocultarSeccionPagos;
    </script>
</body>
</html>