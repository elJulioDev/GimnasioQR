{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de {{ user_detail.get_full_name }} - Moderador</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/indexModerador.css' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'img/icono.svg' %}">
    <style>
        /* Estilos específicos para la vista de detalles */
        body { padding: 2rem; display: block; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header con Avatar */
        .details-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; background: #1e1e1e; padding: 2rem; border-radius: 12px; border: 1px solid #333; }
        .user-info-header { display: flex; align-items: center; gap: 1.5rem; }
        .avatar-large { width: 80px; height: 80px; background: #3c40c6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; }
        .user-title h1 { font-size: 1.8rem; margin-bottom: 5px; color: #fff; }
        .status-pill { padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-block; }
        .status-active { background: rgba(46, 213, 115, 0.15); color: #2ed573; border: 1px solid #2ed573; }
        .status-inactive { background: rgba(255, 71, 87, 0.15); color: #ff4757; border: 1px solid #ff4757; }

        /* Botones de Acción */
        .header-actions { display: flex; gap: 1rem; }
        .btn-action { padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.2s; border: none; cursor: pointer; font-size: 0.95rem; }
        .btn-back { background: transparent; border: 1px solid #555; color: #ccc; }
        .btn-back:hover { background: #333; color: #fff; }
        .btn-edit { background: #3c40c6; color: white; }
        .btn-edit:hover { background: #575fcf; }
        .btn-delete { background: rgba(255, 71, 87, 0.1); color: #ff4757; border: 1px solid #ff4757; }
        .btn-delete:hover { background: rgba(255, 71, 87, 0.2); }

        /* Grilla de Tarjetas */
        .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .card { background: #1e1e1e; padding: 1.5rem; border-radius: 12px; border: 1px solid #333; }
        .card-title { color: #00E676; font-size: 1.1rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* --- CAMBIOS AQUÍ PARA ARREGLAR EL CORREO --- */
        .info-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; /* Alinea verticalmente */
            margin-bottom: 12px; 
            padding-bottom: 12px; 
            border-bottom: 1px solid #2a2a2a;
            gap: 15px; /* Espacio mínimo entre etiqueta y valor */
        }
        .info-row:last-child { border-bottom: none; margin-bottom: 0; }
        
        .label { 
            color: #888; 
            font-weight: 500;
            flex-shrink: 0; /* Evita que la etiqueta se encoja */
        }
        
        .value { 
            color: #fff; 
            font-weight: 600; 
            text-align: right;
            
            /* Propiedades para truncar el texto largo */
            white-space: nowrap;      /* No permite saltos de línea */
            overflow: hidden;         /* Oculta el texto que se desborda */
            text-overflow: ellipsis;  /* Añade "..." al final */
            min-width: 0;             /* Necesario para que funcione en flexbox */
            flex: 1;                  /* Toma el espacio disponible */
        }
        /* -------------------------------------------- */

        /* Tabla Logs */
        .logs-table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; /* Fija el ancho de las columnas */ }
        .logs-table th { text-align: left; color: #888; font-size: 0.85rem; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .logs-table td { padding: 12px 0; color: #fff; border-bottom: 1px solid #2a2a2a; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; /* Trunca texto en tabla también */ }
        .log-status.allowed { color: #2ed573; }
        .log-status.denied { color: #ff4757; }

        /* Modal Delete */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #1e1e1e; padding: 2rem; border-radius: 12px; border: 1px solid #ff4757; text-align: center; max-width: 400px; width: 90%; }
    </style>
</head>
<body>

<div class="container">
    <div class="details-header">
        <div class="user-info-header">
            <div class="avatar-large">
                {{ user_detail.first_name.0|upper }}{{ user_detail.last_name.0|upper }}
            </div>
            <div class="user-title">
                <h1>{{ user_detail.get_full_name }}</h1>
                <span class="status-pill {% if user_detail.is_active_member %}status-active{% else %}status-inactive{% endif %}">
                    {% if user_detail.is_active_member %}
                        <i class="fas fa-check-circle"></i> Membresía Activa
                    {% else %}
                        <i class="fas fa-times-circle"></i> Sin Acceso
                    {% endif %}
                </span>
                <span style="color: #888; margin-left: 10px; font-size: 0.9rem;">{{ user_detail.rut }}</span>
            </div>
        </div>
        <div class="header-actions">
            <a href="{% url 'index_moderador' %}" class="btn-action btn-back">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
            
            <a href="{% url 'moderador_editar_usuario' user_detail.id %}" class="btn-action btn-edit">
                <i class="fas fa-edit"></i> Editar
            </a>
            
            <button onclick="openDeleteModal()" class="btn-action btn-delete">
                <i class="fas fa-trash-alt"></i> Eliminar
            </button>
        </div>
    </div>

    <div class="details-grid">
        <div class="card">
            <h3 class="card-title"><i class="far fa-id-card"></i> Datos Personales</h3>
            <div class="info-row">
                <span class="label">Correo:</span>
                <span class="value" title="{{ user_detail.email }}">{{ user_detail.email }}</span>
            </div>
            <div class="info-row">
                <span class="label">Teléfono:</span>
                <span class="value">{{ user_detail.phone|default:"No registrado" }}</span>
            </div>
            <div class="info-row">
                <span class="label">Fecha Nacimiento:</span>
                <span class="value">{{ user_detail.birthdate|date:"d/m/Y"|default:"-" }}</span>
            </div>
            <div class="info-row">
                <span class="label">Rol:</span>
                <span class="value" style="text-transform: capitalize;">{{ user_detail.role }}</span>
            </div>
        </div>

        <div class="card">
            <h3 class="card-title"><i class="fas fa-ticket-alt"></i> Membresía Actual</h3>
            {% with membership=user_detail.get_active_membership %}
                {% if membership %}
                    <div class="info-row">
                        <span class="label">Plan:</span>
                        <span class="value" style="color: #00E676;">{{ membership.plan.name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Inicio:</span>
                        <span class="value">{{ membership.start_date|date:"d/m/Y" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Vencimiento:</span>
                        <span class="value">{{ membership.end_date|date:"d/m/Y" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Días Restantes:</span>
                        <span class="value">{{ membership.days_remaining }} días</span>
                    </div>
                {% else %}
                    <p style="color: #888; text-align: center; padding: 1rem;">No tiene membresía activa.</p>
                {% endif %}
            {% endwith %}
        </div>

        <div class="card" style="grid-column: 1 / -1;">
            <h3 class="card-title"><i class="fas fa-history"></i> Historial de Accesos (Recientes)</h3>
            <table class="logs-table">
                <thead>
                    <tr>
                        <th>Fecha y Hora</th>
                        <th>Estado</th>
                        <th>Plan Usado</th>
                        <th>Razón (si denegado)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in access_logs %}
                    <tr>
                        <td>{{ log.timestamp|date:"d/m/Y H:i:s" }}</td>
                        <td class="log-status {{ log.status }}">
                            {% if log.status == 'allowed' %}
                                <i class="fas fa-check"></i> Permitido
                            {% else %}
                                <i class="fas fa-ban"></i> Denegado
                            {% endif %}
                        </td>
                        <td>{{ log.membership.plan.name|default:"-" }}</td>
                        <td>{{ log.denial_reason|default:"-" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666;">Sin registros recientes.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff4757; margin-bottom: 1rem;"></i>
        <h2 style="color: #fff; margin-bottom: 1rem;">¿Eliminar Socio?</h2>
        <p style="color: #ccc; margin-bottom: 2rem;">Esta acción eliminará al usuario <strong>{{ user_detail.get_full_name }}</strong> permanentemente.</p>
        
        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button onclick="closeDeleteModal()" class="btn-action btn-back" style="border: 1px solid #555;">Cancelar</button>
            <form action="{% url 'moderador_eliminar_usuario' user_detail.id %}" method="POST">
                {% csrf_token %}
                <button type="submit" class="btn-action btn-delete">Sí, Eliminar</button>
            </form>
        </div>
    </div>
</div>

<script>
    function openDeleteModal() { document.getElementById('deleteModal').classList.add('active'); }
    function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('active'); }
</script>

</body>
</html>