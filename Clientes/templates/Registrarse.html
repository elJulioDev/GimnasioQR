{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - ClubHouse Digital</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/Registrarse.css' %}">
</head>
<body>

    <div class="bg-decoration bg-decoration-1"></div>
    <div class="bg-decoration bg-decoration-2"></div>

    <div class="main-wrapper">
        <div class="register-card">
            
            <div class="card-sidebar">
                <div class="sidebar-header">
                    <div class="logo-icon"><i class="fas fa-dumbbell"></i></div>
                    <span>ClubHouse</span>
                </div>

                <div class="progress-vertical">
                    <div class="step-item active" data-step="1">
                        <div class="step-indicator">1</div>
                        <div class="step-text">
                            <strong>Elige tu Plan</strong>
                            <span>Comienza aquí</span>
                        </div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step-item" data-step="2">
                        <div class="step-indicator">2</div>
                        <div class="step-text">
                            <strong>Tus Datos</strong>
                            <span>Información personal</span>
                        </div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step-item" data-step="3">
                        <div class="step-indicator">3</div>
                        <div class="step-text">
                            <strong>Pago</strong>
                            <span>Finalizar</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <p>¿Ya tienes cuenta?</p>
                    <a href="{% url 'inicio_sesion' %}" class="btn-outline-sm">Iniciar Sesión</a>
                </div>
            </div>

            <div class="card-content">
                <form id="registerForm">
                    {% csrf_token %}

                    <div class="step-panel active" id="step1">
                        <div class="panel-header">
                            <h2>Selecciona tu Objetivo</h2>
                            <p>Elige el plan que mejor se adapte a tu ritmo.</p>
                        </div>

                        <div class="plans-scroll-container">
                            {% for plan in plans %}
                            <label class="plan-card-horizontal">
                                <input type="radio" name="selected_plan" value="{{ plan.plan_type }}" 
                                    data-price="{{ plan.price }}" 
                                    data-name="{{ plan.name }}"
                                    onclick="selectPlan(this)">
                                
                                {% if plan.plan_type == 'completo' or plan.plan_type == 'vip' %}
                                    <div class="horizontal-badge">RECOMENDADO</div>
                                {% endif %}

                                <div class="plan-horizontal-content">
                                    <div class="plan-header-row">
                                        <span class="plan-name">{{ plan.name }}</span>
                                        <div class="plan-price">
                                            ${{ plan.price|floatformat:0 }}<span>/mes</span>
                                        </div>
                                    </div>

                                    {% if plan.description %}
                                        <p class="plan-description-text">
                                            {{ plan.description }}
                                        </p>
                                    {% endif %}

                                    <div class="plan-features-grid">
                                        <div class="feature-item">
                                            <i class="fas fa-calendar-alt"></i> {{ plan.access_days }}
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-clock"></i> {{ plan.duration_days }} días
                                        </div>
                                        
                                        {% if plan.includes_classes %}
                                            <div class="feature-item">
                                                <i class="fas fa-dumbbell"></i> Clases Grupales
                                            </div>
                                        {% endif %}
                                        
                                        {% if plan.includes_nutritionist %}
                                            <div class="feature-item">
                                                <i class="fas fa-apple-alt"></i> Nutricionista
                                            </div>
                                        {% endif %}

                                        {% if plan.benefits %}
                                            <div class="feature-item" style="grid-column: 1 / -1; color: #fff;">
                                                <i class="fas fa-star" style="color: gold;"></i> {{ plan.benefits }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="select-indicator-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </label>
                            {% endfor %}
                        </div>

                        <div class="panel-actions">
                            <button type="button" class="btn btn-primary" id="btnStep1" onclick="nextStep()" disabled>
                                Siguiente <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="step-panel" id="step2">
                        <div class="panel-header">
                            <h2>Crea tu Perfil</h2>
                            <p>Datos necesarios para generar tu acceso QR.</p>
                        </div>

                        <div class="compact-form-grid">
                            <div class="form-group">
                                <label>RUT</label>
                                <input type="text" id="rut" name="rut" placeholder="12.345.678-9" required>
                            </div>
                            <div class="form-group">
                                <label>Fecha Nacimiento</label>
                                <input type="date" id="birthdate" name="birthdate" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre</label>
                                <input type="text" id="firstName" name="firstName" placeholder="Tu nombre" required>
                            </div>
                            <div class="form-group">
                                <label>Apellido</label>
                                <input type="text" id="lastName" name="lastName" placeholder="Tu apellido" required>
                            </div>
                            <div class="form-group full-width">
                                <label>Email</label>
                                <input type="email" id="email" name="email" placeholder="correo@ejemplo.com" required>
                            </div>
                            <div class="form-group">
                                <label>Teléfono</label>
                                <input type="tel" id="phone" name="phone" placeholder="+56 9..." required>
                            </div>
                            <div class="form-group">
                                <label>Contraseña</label>
                                <input type="password" id="password" name="password" placeholder="Min 8 caracteres" required>
                            </div>
                            <div class="form-group">
                                <label>Confirmar</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Repetir contraseña" required>
                            </div>
                        </div>

                        <div class="panel-actions">
                            <button type="button" class="btn btn-text" onclick="prevStep()">Volver</button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Ir al Pago <i class="fas fa-credit-card"></i>
                            </button>
                        </div>
                    </div>

                    <div class="step-panel" id="step3">
                        <div class="panel-header">
                            <h2>Finalizar Inscripción</h2>
                            <p>Selecciona tu método de pago preferido.</p>
                        </div>

                        <div class="payment-summary-box">
                            <div class="summary-row">
                                <span id="summaryPlanName">Plan Seleccionado</span>
                                <strong id="summaryPlanPrice">$0</strong>
                            </div>
                        </div>

                        <div class="payment-options-grid">
                            <label class="payment-option">
                                <input type="radio" name="paymentMethod" value="efectivo" onclick="enablePayment()">
                                <div class="option-content">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <span>Efectivo</span>
                                    <small>Pagar en recepción</small>
                                </div>
                            </label>
                            <label class="payment-option">
                                <input type="radio" name="paymentMethod" value="transferencia" onclick="enablePayment()">
                                <div class="option-content">
                                    <i class="fas fa-university"></i>
                                    <span>Transferencia</span>
                                    <small>Datos bancarios</small>
                                </div>
                            </label>
                            <label class="payment-option">
                                <input type="radio" name="paymentMethod" value="tarjeta" onclick="enablePayment()">
                                <div class="option-content">
                                    <i class="fas fa-credit-card"></i>
                                    <span>Tarjeta</span>
                                    <small>Débito/Crédito</small>
                                </div>
                            </label>
                        </div>

                        <div class="options-stack">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="sendQREmail" name="sendQREmail" checked>
                                <label for="sendQREmail">
                                    Enviar código QR de acceso al correo
                                    <small style="display:block; color:#666; font-size:0.75em;">Necesario para entrar al gimnasio</small>
                                </label>
                            </div>

                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="sendContract" name="sendContract" checked>
                                <label for="sendContract">
                                    Generar y enviar Contrato de Socio (PDF)
                                    <small style="display:block; color:#666; font-size:0.75em;">Incluye términos, condiciones y datos del plan</small>
                                </label>
                            </div>
                        </div>

                        <div class="panel-actions">
                            <button type="button" class="btn btn-text" onclick="prevStep()">Volver</button>
                            <button type="button" class="btn btn-primary" id="btnPayment" onclick="processPayment()" disabled>
                                Confirmar y Registrarse
                            </button>
                        </div>
                    </div>

                    <div class="step-panel" id="step4">
                        <div class="success-wrapper">
                            
                            <div class="success-header">
                                <div class="success-icon-anim">
                                    <div class="ripple"></div>
                                    <i class="fas fa-check"></i>
                                </div>
                                <h2>¡Bienvenido al Team!</h2>
                                <p>Tu cuenta está lista. Este es tu pase digital.</p>
                            </div>

                            <div class="digital-pass">
                                <div class="pass-top">
                                    <span class="pass-label">MEMBER ACCESS</span>
                                    <div class="pass-holes"></div>
                                </div>
                                
                                <div class="qr-frame-wrapper">
                                    <div class="corner-border topleft"></div>
                                    <div class="corner-border topright"></div>
                                    <div class="corner-border bottomleft"></div>
                                    <div class="corner-border bottomright"></div>
                                    
                                    <div id="qrContainer" class="qr-content"></div>
                                </div>

                                <p class="scan-instruction">
                                    <i class="fas fa-wifi"></i> Escanea en recepción
                                </p>
                            </div>

                            <div class="success-footer">
                                <div class="info-pill">
                                    <i class="fas fa-envelope-open-text"></i>
                                    <span>Copia enviada a tu correo</span>
                                </div>
                                
                                <button type="button" class="btn btn-primary btn-block glow-effect" onclick="goToLogin()">
                                    Iniciar Sesión y Entrenar
                                </button>
                            </div>

                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <div id="customModal" class="custom-modal-overlay">
        <div class="custom-modal">
            <div class="modal-icon-box error" id="modalIcon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="modal-title" id="modalTitle">Error</h3>
            <p class="modal-text" id="modalMessage">Mensaje de error aquí.</p>
            <button class="btn btn-primary modal-btn" onclick="closeCustomModal()">Entendido</button>
        </div>
    </div>

<script>
    // --- Utils ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- Modal Logic ---
    function showCustomModal(title, message, type = 'error') {
        const modal = document.getElementById('customModal');
        const iconBox = document.getElementById('modalIcon');
        const icon = iconBox.querySelector('i');
        
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;
        
        iconBox.className = 'modal-icon-box ' + type;
        if (type === 'success') {
            icon.className = 'fas fa-check';
        } else {
            icon.className = 'fas fa-exclamation-triangle';
        }
        
        modal.style.display = 'flex';
    }

    function closeCustomModal() {
        document.getElementById('customModal').style.display = 'none';
    }

    // --- Step Logic ---
    let currentStep = 1;
    let selectedPlanData = null;

    function nextStep() {
        if (validateStep(currentStep)) {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.querySelector(`.step-item[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.step-item[data-step="${currentStep}"]`).classList.add('completed');
            
            currentStep++;
            
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.querySelector(`.step-item[data-step="${currentStep}"]`).classList.add('active');
        }
    }

    function prevStep() {
        document.getElementById(`step${currentStep}`).classList.remove('active');
        document.querySelector(`.step-item[data-step="${currentStep}"]`).classList.remove('active');
        
        currentStep--;
        
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.querySelector(`.step-item[data-step="${currentStep}"]`).classList.add('active');
        document.querySelector(`.step-item[data-step="${currentStep}"]`).classList.remove('completed');
    }

    function selectPlan(radio) {
        selectedPlanData = {
            type: radio.value,
            price: radio.dataset.price,
            name: radio.dataset.name
        };
        document.getElementById('summaryPlanName').textContent = selectedPlanData.name;
        document.getElementById('summaryPlanPrice').textContent = '$' + parseInt(selectedPlanData.price).toLocaleString('es-CL');
        document.getElementById('btnStep1').disabled = false;
    }

    function enablePayment() {
        document.getElementById('btnPayment').disabled = false;
    }

    function validateStep(step) {
        if (step === 1 && !selectedPlanData) {
            showCustomModal('Atención', 'Por favor selecciona un plan para continuar.', 'error');
            return false;
        }
        if (step === 2) {
            const required = ['rut', 'firstName', 'lastName', 'email', 'phone', 'password', 'confirmPassword', 'birthdate'];
            for (let id of required) {
                if (!document.getElementById(id).value) {
                    showCustomModal('Campos Incompletos', 'Por favor completa todos los campos del formulario.', 'error');
                    return false;
                }
            }
            if (document.getElementById('password').value !== document.getElementById('confirmPassword').value) {
                showCustomModal('Contraseña', 'Las contraseñas no coinciden.', 'error');
                return false;
            }
            if (document.getElementById('password').value.length < 8) {
                showCustomModal('Seguridad', 'La contraseña debe tener al menos 8 caracteres.', 'error');
                return false;
            }
        }
        return true;
    }

    // --- Registration Logic ---
    async function processPayment() {
        const btn = document.getElementById('btnPayment');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

        const formData = {
            rut: document.getElementById('rut').value,
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            birthdate: document.getElementById('birthdate').value,
            password: document.getElementById('password').value,
            plan: selectedPlanData.type,
            paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
            sendQREmail: document.getElementById('sendQREmail').checked,
            sendContract: document.getElementById('sendContract').checked
        };

        try {
            const response = await fetch('{% url "process_registration" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Error del servidor desconocido' }));
                throw new Error(errorData.error || 'Error en la solicitud');
            }

            const data = await response.json();

            if (data.success) {
                if (data.qr_code_url) {
                    document.getElementById('qrContainer').innerHTML = `<img src="${data.qr_code_url}" alt="QR Code">`;
                }
                nextStep(); // Ir al paso 4
            } else {
                showCustomModal('Error de Registro', data.error, 'error');
                resetButton();
            }

        } catch (error) {
            console.error("Registration Error:", error);
            if(currentStep !== 4) {
                showCustomModal('Error', error.message || 'Ocurrió un problema de conexión.', 'error');
                resetButton();
            }
        }
    }

    function resetButton() {
        const btn = document.getElementById('btnPayment');
        btn.disabled = false;
        btn.textContent = 'Confirmar y Registrarse';
    }

    function goToLogin() {
        window.location.href = '{% url "inicio_sesion" %}';
    }
</script>
</body>
</html>